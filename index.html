<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuckDB Oat - Resizable & Elegant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --oat-cream: #FDFBF7;
            --oat-warm: #F5F1EB;
            --oat-beige: #E8E2D9;
            --oat-taupe: #D4CFC7;
            --oat-stone: #A8A39A;
            --oat-charcoal: #5C5852;
            --oat-espresso: #3D3A36;
            --oat-accent: #B8956A;
            --oat-accent-hover: #9A7B56;
            --oat-success: #7A9E7E;
            --oat-error: #C17B7B;
            --font-serif: 'Merriweather', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        [data-theme="dark"] {
            --oat-cream: #1C1917;
            --oat-warm: #292524;
            --oat-beige: #44403C;
            --oat-taupe: #57534E;
            --oat-stone: #A8A29E;
            --oat-charcoal: #D6D3D1;
            --oat-espresso: #FAFAF9;
            --oat-accent: #D4A373;
            --oat-accent-hover: #E4B48A;
            --oat-success: #86EFAC;
            --oat-error: #FCA5A5;
        }
        * { transition: background-color 0.2s, border-color 0.2s, color 0.2s; }
        body { font-family: var(--font-sans); background: var(--oat-cream); color: var(--oat-espresso); }
        .font-serif { font-family: var(--font-serif); }
        .font-mono { font-family: var(--font-mono); }
        h1, h2, h3, .serif-heading { font-family: var(--font-serif); font-weight: 400; letter-spacing: -0.02em; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--oat-taupe); border-radius: 3px; }
        .btn-oat { background: var(--oat-warm); border: 1px solid var(--oat-beige); color: var(--oat-charcoal); }
        .btn-oat:hover { background: var(--oat-beige); border-color: var(--oat-taupe); color: var(--oat-espresso); }
        .btn-primary { background: var(--oat-espresso); color: var(--oat-cream); border: 1px solid var(--oat-espresso); }
        .btn-primary:hover { background: var(--oat-charcoal); border-color: var(--oat-charcoal); }
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
        .toast { background: var(--oat-cream); border: 1px solid var(--oat-beige); border-left: 3px solid var(--oat-accent); padding: 12px 16px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 10px; min-width: 280px; transform: translateX(400px); transition: transform 0.3s cubic-bezier(0.16,1,0.3,1); }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--oat-success); }
        .toast.error { border-left-color: var(--oat-error); }
        .suggestions { position: absolute; background: var(--oat-cream); border: 1px solid var(--oat-beige); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-height: 280px; overflow-y: auto; z-index: 100; display: none; min-width: 240px; }
        .suggestion-header { padding: 6px 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--oat-stone); background: var(--oat-warm); border-bottom: 1px solid var(--oat-beige); }
        .suggestion-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--oat-beige); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background: var(--oat-warm); }
        .drop-zone { border: 2px dashed var(--oat-taupe); border-radius: 8px; transition: all 0.2s; background: var(--oat-warm); }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--oat-accent); background: var(--oat-beige); }
        .data-table th { font-weight: 500; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--oat-stone); background: var(--oat-warm); }
        .data-table td { font-size: 12px; font-family: var(--font-mono); color: var(--oat-charcoal); }
        .main-container { display: flex; flex-direction: column; height: 100%; }
        .main-container.horizontal { flex-direction: row; }
        .editor-section { flex: 1; min-height: 0; position: relative; }
        .main-container.horizontal .editor-section { width: 60%; height: 100%; }
        .resizer { height: 6px; background: var(--oat-beige); cursor: row-resize; display: flex; align-items: center; justify-content: center; transition: background 0.2s; position: relative; }
        .resizer:hover { background: var(--oat-accent); }
        .resizer::after { content: ''; width: 40px; height: 2px; background: var(--oat-taupe); border-radius: 1px; }
        .main-container.horizontal .resizer { width: 6px; height: 100%; cursor: col-resize; }
        .main-container.horizontal .resizer::after { width: 2px; height: 40px; }
        .results-section { height: 40%; min-height: 150px; display: flex; flex-direction: column; background: var(--oat-warm); }
        .main-container.horizontal .results-section { width: 40%; height: 100%; }
        .layout-toggle { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--oat-warm); border: 1px solid var(--oat-beige); color: var(--oat-charcoal); transition: all 0.2s; }
        .layout-toggle:hover { background: var(--oat-beige); color: var(--oat-espresso); }
        .help-modal { position: fixed; inset: 0; background: rgba(28,25,23,0.6); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .help-modal.show { display: flex; }
        .help-content { background: var(--oat-cream); border-radius: 12px; max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--oat-beige); }
        .code-block { background: var(--oat-warm); border: 1px solid var(--oat-beige); border-radius: 6px; padding: 12px; font-family: var(--font-mono); font-size: 11px; overflow-x: auto; color: var(--oat-charcoal); margin: 8px 0; }
        .tag { display: inline-block; padding: 2px 8px; background: var(--oat-warm); border: 1px solid var(--oat-beige); border-radius: 4px; font-size: 10px; color: var(--oat-charcoal); margin-right: 6px; margin-bottom: 6px; }
        .theme-toggle { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--oat-warm); border: 1px solid var(--oat-beige); color: var(--oat-charcoal); }
        .theme-toggle:hover { background: var(--oat-beige); color: var(--oat-espresso); }
        .loader { width: 16px; height: 16px; border: 2px solid var(--oat-beige); border-top-color: var(--oat-accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .compression-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 6px; background: #FEF3C7; color: #92400E; border-radius: 4px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .active-table { background: var(--oat-beige) !important; border-left: 3px solid var(--oat-accent); }
        .quick-action-btn { background: var(--oat-cream); border: 1px solid var(--oat-beige); border-radius: 9999px; font-size: 10px; font-weight: 500; color: var(--oat-charcoal); padding: 0.375rem 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.08); transition: background 0.2s, color 0.2s; }
        .quick-action-btn:hover { background: var(--oat-warm); }
        [data-theme="dark"] #resultStats { color: var(--oat-charcoal); }
        [data-theme="dark"] .quick-action-btn { background: var(--oat-warm); color: var(--oat-espresso); }
        [data-theme="dark"] .toast { background: var(--oat-warm); border-color: var(--oat-beige); }
        [data-theme="dark"] .suggestions { background: var(--oat-warm); }
        [data-theme="dark"] .help-content { background: var(--oat-warm); border-color: var(--oat-beige); }
    </style>
<base target="_blank">
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center gap-3" style="background: var(--oat-cream);">
        <div class="loader" style="width: 24px; height: 24px;"></div>
        <p class="text-sm font-serif" style="color: var(--oat-stone);">Initializing DuckDB...</p>
    </div>

    <!-- Toasts -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Help Modal -->
    <div id="helpModal" class="help-modal" onclick="if(event.target===this) closeHelp()">
        <div class="help-content">
            <div class="p-5 border-b flex justify-between items-center" style="background: var(--oat-warm); border-color: var(--oat-beige);">
                <div>
                    <h2 class="text-xl font-serif" style="color: var(--oat-espresso);">DuckDB Guide</h2>
                    <p class="text-xs mt-0.5" style="color: var(--oat-stone);">Elegant data exploration</p>
                </div>
                <button onclick="closeHelp()" class="w-8 h-8 flex items-center justify-center rounded-lg transition-colors" style="color: var(--oat-stone); background: var(--oat-cream);"><i class="fas fa-times"></i></button>
            </div>
            <div>
                <div class="p-5 border-b" style="border-color: var(--oat-beige);">
                    <h3 class="text-sm font-serif mb-3 flex items-center gap-2" style="color: var(--oat-espresso);"><i class="fas fa-rocket" style="color: var(--oat-accent);"></i> Quick Start</h3>
                    <div class="grid grid-cols-2 gap-3 text-xs" style="color: var(--oat-charcoal);">
                        <div class="flex items-start gap-2"><span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] shrink-0 mt-0.5 text-white" style="background: var(--oat-accent);">1</span><span><strong>Import:</strong> Drop CSV, CSV.GZ, JSON, Parquet files</span></div>
                        <div class="flex items-start gap-2"><span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] shrink-0 mt-0.5 text-white" style="background: var(--oat-accent);">2</span><span><strong>Autocomplete:</strong> Type for suggestions, Tab to accept</span></div>
                        <div class="flex items-start gap-2"><span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] shrink-0 mt-0.5 text-white" style="background: var(--oat-accent);">3</span><span><strong>Layout:</strong> Toggle horizontal/vertical split</span></div>
                        <div class="flex items-start gap-2"><span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] shrink-0 mt-0.5 text-white" style="background: var(--oat-accent);">4</span><span><strong>Resize:</strong> Drag divider to adjust panels</span></div>
                    </div>
                </div>
                <div class="p-5 border-b" style="border-color: var(--oat-beige);">
                    <h3 class="text-sm font-serif mb-3 flex items-center gap-2" style="color: var(--oat-espresso);"><i class="fas fa-file-import" style="color: var(--oat-accent);"></i> Supported Files</h3>
                    <div class="flex flex-wrap">
                        <span class="tag"><i class="fas fa-file-csv mr-1" style="color: var(--oat-success);"></i>CSV</span>
                        <span class="tag"><i class="fas fa-compress-alt mr-1" style="color:#92400E;"></i>CSV.GZ</span>
                        <span class="tag"><i class="fas fa-file-code mr-1" style="color:#60A5FA;"></i>JSON</span>
                        <span class="tag"><i class="fas fa-file-archive mr-1" style="color:#FBBF24;"></i>Parquet</span>
                        <span class="tag"><i class="fas fa-file-excel mr-1" style="color:#34D399;"></i>Excel</span>
                    </div>
                </div>
                <div class="p-5 border-b" style="border-color: var(--oat-beige);">
                    <h3 class="text-sm font-serif mb-3 flex items-center gap-2" style="color: var(--oat-espresso);"><i class="fas fa-code" style="color: var(--oat-accent);"></i> Essential Queries</h3>
                    <div class="space-y-2">
                        <div class="code-block">SELECT * FROM table_name LIMIT 100;</div>
                        <div class="code-block">SELECT COUNT(*), AVG(price) FROM sales GROUP BY category;</div>
                    </div>
                </div>
                <div class="p-5" style="background: var(--oat-warm);">
                    <h3 class="text-sm font-serif mb-3 flex items-center gap-2" style="color: var(--oat-espresso);"><i class="fas fa-lightbulb" style="color: var(--oat-accent);"></i> Pro Tips</h3>
                    <ul class="text-xs space-y-2 list-disc list-inside" style="color: var(--oat-charcoal);">
                        <li>Click a table to select it, then use Preview/Count/Stats buttons</li>
                        <li>Drag the resize handle to adjust panel sizes</li>
                        <li>Toggle layout button to switch between horizontal and vertical</li>
                    </ul>
                </div>
            </div>
            <div class="p-4 border-t" style="background: var(--oat-warm); border-color: var(--oat-beige);">
                <button onclick="closeHelp()" class="w-full py-2.5 rounded-lg text-sm font-medium text-white transition-colors" style="background: var(--oat-accent);">Start Exploring</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="h-14 border-b flex items-center justify-between px-4 shrink-0" style="background: var(--oat-cream); border-color: var(--oat-beige);">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-md flex items-center justify-center" style="background: var(--oat-accent);"><i class="fas fa-database text-white text-xs"></i></div>
            <div><h1 class="font-serif text-lg tracking-tight" style="color: var(--oat-espresso);">DuckDB</h1></div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()" class="theme-toggle" title="Toggle theme"><i class="fas fa-moon text-xs" id="themeIcon"></i></button>
            <button onclick="toggleLayout()" class="layout-toggle" title="Toggle layout"><i class="fas fa-columns text-xs" id="layoutIcon"></i></button>
            <button onclick="openHelp()" class="btn-oat px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-2"><i class="fas fa-book-open" style="color: var(--oat-stone);"></i><span>Guide</span></button>
            <input type="file" id="fileInput" class="hidden" accept=".csv,.csv.gz,.tsv,.txt,.parquet,.json,.jsonl,.ndjson,.xlsx,.xls,.gz,.bz2" multiple>
            <button onclick="document.getElementById('fileInput').click()" class="btn-oat px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-2"><i class="fas fa-plus" style="color: var(--oat-stone);"></i><span>Import</span></button>
            <button onclick="executeQuery()" class="btn-primary px-4 py-1.5 rounded-lg text-xs font-medium flex items-center gap-2"><i class="fas fa-play text-[10px]"></i><span>Run</span></button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 border-r flex flex-col shrink-0" style="background: var(--oat-cream); border-color: var(--oat-beige);">
            <div class="p-3 border-b" style="border-color: var(--oat-beige);">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-serif font-semibold uppercase tracking-wider" style="color: var(--oat-stone);">Tables</span>
                    <button onclick="refreshTables()" class="p-1 rounded transition-colors" style="color: var(--oat-stone);"><i class="fas fa-sync-alt text-xs"></i></button>
                </div>
                <input type="text" id="tableSearch" placeholder="Search tables..."
                    class="w-full rounded-md px-3 py-1.5 text-xs focus:outline-none transition-all font-serif"
                    style="background: var(--oat-warm); border: 1px solid var(--oat-beige); color: var(--oat-espresso);"
                    oninput="filterTables(this.value)">
            </div>
            <div id="dropZone" class="drop-zone mx-3 mt-3 p-3 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt mb-1 text-lg" style="color: var(--oat-stone);"></i>
                <p class="text-[10px] font-medium" style="color: var(--oat-charcoal);">Drop files here</p>
                <p class="text-[9px] mt-0.5" style="color: var(--oat-stone);">CSV.GZ supported</p>
            </div>
            <div id="tableList" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-xs text-center py-8 italic font-serif" style="color: var(--oat-stone);">No data loaded</div>
            </div>
        </aside>

        <!-- Main with resizable panels -->
        <main class="flex-1 flex flex-col min-w-0 main-container" id="mainContainer" style="background: var(--oat-cream);">
            <!-- Editor Section -->
            <div class="editor-section flex flex-col" id="editorSection">
                <div class="px-3 py-2 border-b flex justify-between items-center" style="background: var(--oat-warm); border-color: var(--oat-beige);">
                    <div class="flex items-center gap-3"><span class="text-xs font-serif font-medium uppercase tracking-wider" style="color: var(--oat-stone);">Editor</span>
                        <div class="flex items-center gap-2 text-[10px]" style="color: var(--oat-stone);">
                            <span class="px-1.5 py-0.5 rounded font-mono" style="background: var(--oat-cream); border: 1px solid var(--oat-beige);">Tab</span>
                            <span>to complete</span>
                            <span class="px-1.5 py-0.5 rounded font-mono ml-2" style="background: var(--oat-cream); border: 1px solid var(--oat-beige);">Ctrl+Enter</span>
                            <span>to run</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="formatSQL()" class="text-[10px] px-2 py-1 rounded transition-colors" style="color: var(--oat-stone);">Format</button>
                        <button onclick="clearEditor()" class="text-[10px] px-2 py-1 rounded transition-colors" style="color: var(--oat-stone);">Clear</button>
                    </div>
                </div>

                <div class="relative flex-1">
                    <textarea id="sqlEditor" class="w-full h-full p-4 resize-none focus:outline-none font-mono text-sm"
                        spellcheck="false"
                        placeholder="-- Write SQL here
-- Select a table from sidebar, then use Preview/Count/Stats
-- Or write your own query and press Ctrl+Enter"
                        style="background: var(--oat-cream); color: var(--oat-espresso);"></textarea>
                    <div id="inlineSuggestions" class="suggestions"></div>
                </div>

                <!-- Quick Actions -->
                <div id="quickActions" class="absolute bottom-4 left-4 flex gap-2 opacity-0 transition-opacity duration-300 pointer-events-none">
                    <button class="quick-action-btn" onclick="previewTable()"><i class="fas fa-eye mr-1"></i> Preview</button>
                    <button class="quick-action-btn" onclick="countTable()"><i class="fas fa-calculator mr-1"></i> Count</button>
                    <button class="quick-action-btn" onclick="statsTable()"><i class="fas fa-chart-bar mr-1"></i> Stats</button>
                </div>
            </div>

            <!-- Resizer -->
            <div class="resizer" id="resizer" title="Drag to resize"></div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="px-3 py-2 border-b flex justify-between items-center" style="background: var(--oat-cream); border-color: var(--oat-beige);">
                    <div class="flex items-center gap-3"><span class="text-xs font-serif font-medium uppercase tracking-wider" style="color: var(--oat-stone);">Results</span>
                        <span id="resultStats" class="text-[10px] hidden font-mono" style="color: var(--oat-stone);"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="copyResults()" class="text-[10px] px-2 py-1 rounded transition-colors flex items-center gap-1" style="color: var(--oat-charcoal);"><i class="fas fa-copy text-[10px]"></i> Copy</button>
                        <button onclick="exportCSV()" class="text-[10px] px-2 py-1 rounded transition-colors flex items-center gap-1" style="color: var(--oat-charcoal);"><i class="fas fa-file-csv text-[10px]"></i> CSV</button>
                    </div>
                </div>

                <div id="resultsContainer" class="flex-1 overflow-auto relative" style="background: var(--oat-cream);">
                    <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center" style="color: var(--oat-stone);">
                        <i class="fas fa-table text-3xl mb-2 opacity-20"></i>
                        <p class="text-xs font-serif">Run a query or select a table</p>
                        <p class="text-[10px] mt-1 opacity-60 font-serif">Click a table to enable quick actions</p>
                    </div>
                    <div id="loadingState" class="absolute inset-0 flex items-center justify-center hidden" style="background: var(--oat-cream);"><div class="loader"></div></div>
                    <table id="resultsTable" class="w-full data-table hidden"><thead class="sticky top-0"></thead><tbody class="divide-y" style="border-color: var(--oat-beige);"></tbody></table>
                    <div id="errorState" class="absolute inset-0 flex items-center justify-center hidden p-6">
                        <div class="rounded-lg p-4 max-w-md" style="background: var(--oat-warm); border: 1px solid var(--oat-error);">
                            <p class="text-xs font-serif font-semibold mb-1" style="color: var(--oat-error);">Error</p>
                            <p id="errorText" class="text-xs font-mono" style="color: var(--oat-charcoal);"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        let db = null, conn = null, currentResults = null, tables = [];
        let columns = {};
        let selectedTable = null; // currently selected table
        let isHorizontal = false; // layout state
        let splitRatio = 0.6; // default 60% editor, 40% results

        // ---------- THEME ----------
        function initTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon(saved);
        }
        function toggleTheme() {
            const cur = document.documentElement.getAttribute('data-theme');
            const nxt = cur === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', nxt);
            localStorage.setItem('theme', nxt);
            updateThemeIcon(nxt);
        }
        function updateThemeIcon(t) { document.getElementById('themeIcon').className = t === 'dark' ? 'fas fa-sun text-xs' : 'fas fa-moon text-xs'; }
        initTheme();
        window.toggleTheme = toggleTheme;

        // ---------- LAYOUT ----------
        function applySplit() {
            if (isHorizontal) {
                // horizontal: editor width, results width
                editorSection.style.width = `${splitRatio * 100}%`;
                resultsSection.style.width = `${(1 - splitRatio) * 100}%`;
                // clear height styles that belong to vertical mode
                editorSection.style.height = '';
                resultsSection.style.height = '';
            } else {
                // vertical: editor height, results height
                editorSection.style.height = `${splitRatio * 100}%`;
                resultsSection.style.height = `${(1 - splitRatio) * 100}%`;
                // clear width styles that belong to horizontal mode
                editorSection.style.width = '';
                resultsSection.style.width = '';
            }
        }

        function toggleLayout() {
            const container = document.getElementById('mainContainer');
            isHorizontal = !isHorizontal;
            if (isHorizontal) {
                container.classList.add('horizontal');
                document.getElementById('layoutIcon').className = 'fas fa-columns text-xs fa-rotate-90';
            } else {
                container.classList.remove('horizontal');
                document.getElementById('layoutIcon').className = 'fas fa-columns text-xs';
            }
            // after changing orientation, re‑apply the stored split ratio
            applySplit();
            localStorage.setItem('layout', isHorizontal ? 'horizontal' : 'vertical');
        }
        const savedLayout = localStorage.getItem('layout');
        if (savedLayout === 'horizontal') toggleLayout(); // will also call applySplit()
        window.toggleLayout = toggleLayout;

        // ---------- RESIZING ----------
        let isResizing = false;
        const resizer = document.getElementById('resizer');
        const editorSection = document.getElementById('editorSection');
        const resultsSection = document.getElementById('resultsSection');

        resizer.addEventListener('mousedown', () => {
            isResizing = true;
            document.body.style.cursor = isHorizontal ? 'col-resize' : 'row-resize';
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', e => {
            if (!isResizing) return;
            const container = document.getElementById('mainContainer');
            const rect = container.getBoundingClientRect();

            if (isHorizontal) {
                const percent = ((e.clientX - rect.left) / rect.width);
                splitRatio = Math.min(Math.max(percent, 0.1), 0.9);
                editorSection.style.width = `${splitRatio * 100}%`;
                resultsSection.style.width = `${(1 - splitRatio) * 100}%`;
            } else {
                const percent = ((e.clientY - rect.top) / rect.height);
                splitRatio = Math.min(Math.max(percent, 0.1), 0.9);
                editorSection.style.height = `${splitRatio * 100}%`;
                resultsSection.style.height = `${(1 - splitRatio) * 100}%`;
            }
        });
        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });

        // ---------- COMPLETIONS ----------
        const completions = {
            keywords: [
                { name: 'SELECT', type: 'keyword', desc: 'Retrieve data' },
                { name: 'FROM', type: 'keyword', desc: 'Specify table' },
                { name: 'WHERE', type: 'keyword', desc: 'Filter rows' },
                { name: 'GROUP BY', type: 'keyword', desc: 'Aggregate' },
                { name: 'ORDER BY', type: 'keyword', desc: 'Sort' },
                { name: 'LIMIT', type: 'keyword', desc: 'Limit rows' },
                { name: 'JOIN', type: 'keyword', desc: 'Combine tables' },
                { name: 'LEFT JOIN', type: 'keyword', desc: 'Keep all left' },
                { name: 'ON', type: 'keyword', desc: 'Join condition' },
                { name: 'AND', type: 'keyword', desc: 'Logical AND' },
                { name: 'OR', type: 'keyword', desc: 'Logical OR' },
                { name: 'WITH', type: 'keyword', desc: 'CTE' },
            ],
            functions: [
                { name: 'COUNT(*)', type: 'function', desc: 'Count rows' },
                { name: 'SUM(', type: 'function', desc: 'Sum values' },
                { name: 'AVG(', type: 'function', desc: 'Average' },
                { name: 'MIN(', type: 'function', desc: 'Minimum' },
                { name: 'MAX(', type: 'function', desc: 'Maximum' },
                { name: 'ROUND(', type: 'function', desc: 'Round number' },
                { name: 'COALESCE(', type: 'function', desc: 'First non‑null' },
                { name: 'CAST(', type: 'function', desc: 'Type cast' },
                { name: 'ROW_NUMBER()', type: 'function', desc: 'Row number' },
                { name: 'RANK()', type: 'function', desc: 'Rank' },
                { name: 'LAG(', type: 'function', desc: 'Previous row' },
                { name: 'LEAD(', type: 'function', desc: 'Next row' },
            ],
            files: [
                { name: "read_csv_auto('", type: 'file', desc: 'Auto‑detect CSV' },
                { name: "read_parquet('", type: 'file', desc: 'Read Parquet' },
                { name: "read_json_auto('", type: 'file', desc: 'Auto‑detect JSON' },
            ]
        };

        // ---------- INITIALISE DUCKDB ----------
        (async () => {
            try {
                const duckdb = await import('https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm');
                const bundle = await duckdb.selectBundle(duckdb.getJsDelivrBundles());
                const worker = new Worker(URL.createObjectURL(new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })));
                db = new duckdb.AsyncDuckDB(new duckdb.ConsoleLogger(), worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                conn = await db.connect();

                // optional extensions
                ['parquet', 'json'].forEach(ext => conn.query(`INSTALL ${ext}; LOAD ${ext};`).catch(()=>{}));

                document.getElementById('loadingOverlay').style.display = 'none';
                showToast('Ready! Import a file to begin', 'success', 4000);
                if (!localStorage.getItem('duckdb_visited')) {
                    setTimeout(openHelp, 500);
                    localStorage.setItem('duckdb_visited', 'true');
                }
            } catch (e) {
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="text-center p-4" style="color: var(--oat-error);">
                        <p class="font-serif font-semibold mb-2">Failed to load DuckDB</p>
                        <p class="text-xs" style="color: var(--oat-stone);">${e.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 rounded text-xs text-white" style="background: var(--oat-accent);">Retry</button>
                    </div>`;
            }
        })();

        // ---------- TOAST ----------
        function showToast(msg, type='info', dur=3000) {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            const ic = {success:'check-circle',error:'exclamation-circle',info:'info-circle'}[type]||'info-circle';
            t.innerHTML = `<i class="fas fa-${ic}" style="color: var(--oat-accent);"></i>
                <span class="flex-1 text-sm font-serif" style="color: var(--oat-espresso);">${msg}</span>
                <button onclick="this.parentElement.remove()" class="text-[10px]" style="color: var(--oat-stone);"><i class="fas fa-times"></i></button>`;
            c.appendChild(t);
            requestAnimationFrame(()=>t.classList.add('show'));
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, dur);
        }

        // ---------- FILE IMPORT ----------
        window.handleFileSelect = async function(e) {
            const files = Array.from(e.target.files || e.dataTransfer?.files || []);
            if (!files.length || !conn) return;
            for (const file of files) {
                try {
                    const fileName = file.name;
                    const ext = fileName.split('.').pop().toLowerCase();
                    const isGz = ext === 'gz';
                    let baseName = fileName;
                    let baseExt = ext;
                    if (isGz) { baseName = fileName.replace(/\.gz$/i,''); baseExt = baseName.split('.').pop().toLowerCase(); }

                    const tableName = baseName.replace(/[^a-zA-Z0-9_]/g,'_').substring(0,50);
                    let arrayBuffer = await file.arrayBuffer();
                    let finalFileName = fileName;
                    let fileLabel = ext.toUpperCase();

                    if (isGz) {
                        showToast(`Decompressing ${fileName}…`, 'info', 2000);
                        try {
                            const decompressed = pako.ungzip(new Uint8Array(arrayBuffer));
                            arrayBuffer = decompressed.buffer;
                            finalFileName = baseName;
                            fileLabel = `${baseExt.toUpperCase()}.GZ`;
                        } catch {
                            showToast(`Failed to unzip ${fileName}`, 'error', 5000);
                            continue;
                        }
                    }

                    await db.registerFileBuffer(finalFileName, new Uint8Array(arrayBuffer));

                    let sql = '';
                    if (['csv','tsv','txt'].includes(baseExt)) sql = `CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_csv_auto('${finalFileName}', header=true)`;
                    else if (baseExt === 'parquet') sql = `CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_parquet('${finalFileName}')`;
                    else if (['json','jsonl','ndjson'].includes(baseExt)) sql = `CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_json_auto('${finalFileName}')`;
                    else throw new Error(`Unsupported: ${baseExt}`);

                    await conn.query(sql);
                    const count = (await conn.query(`SELECT COUNT(*) AS c FROM ${tableName}`)).toArray()[0].c;
                    const schema = await conn.query(`DESCRIBE ${tableName}`);
                    columns[tableName] = schema.toArray().map(r=>r.column_name);

                    // auto‑select the newly imported table
                    selectTable(tableName);

                    const badge = isGz ? '<span class="compression-badge">GZ→CSV</span>' : '';
                    showToast(`${fileLabel}: ${fileName} loaded ${badge} (${count.toLocaleString()} rows)`, 'success', 4000);
                    refreshTables();
                } catch (err) {
                    console.error(err);
                    showToast(`Error: ${err.message}`, 'error', 5000);
                }
            }
            e.target.value = '';
        };
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // ---------- DRAG & DROP ----------
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => { e.preventDefault(); handleFileSelect(e); dropZone.classList.remove('drag-over'); });

        // ---------- TABLE SELECTION ----------
        function selectTable(name) {
            selectedTable = name;
            document.querySelectorAll('#tableList > div').forEach(d => d.classList.remove('active-table'));
            const target = Array.from(document.querySelectorAll('#tableList > div')).find(d => d.textContent.includes(name));
            if (target) target.classList.add('active-table');

            document.getElementById('sqlEditor').value = `SELECT * FROM ${name} LIMIT 100;`;

            const qa = document.getElementById('quickActions');
            qa.style.opacity = '1';
            qa.classList.remove('pointer-events-none');
        }

        // QUICK ACTIONS -------------------------------------------------
        window.previewTable = function() {
            if (!selectedTable) { showToast('Select a table first', 'warning', 2000); return; }
            document.getElementById('sqlEditor').value = `SELECT * FROM ${selectedTable} LIMIT 10;`;
            executeQuery();
        };
        window.countTable = function() {
            if (!selectedTable) { showToast('Select a table first', 'warning', 2000); return; }
            document.getElementById('sqlEditor').value = `SELECT COUNT(*) AS total_rows FROM ${selectedTable};`;
            executeQuery();
        };
        window.statsTable = function() {
            if (!selectedTable) { showToast('Select a table first', 'warning', 2000); return; }
            document.getElementById('sqlEditor').value = `SUMMARIZE ${selectedTable};`;
            executeQuery();
        };

        // ---------- AUTOCOMPLETE ----------
        const editor = document.getElementById('sqlEditor');
        const suggestionsBox = document.getElementById('inlineSuggestions');
        let selIdx = -1, curMatches = [], curWord = '', wStart = 0, wEnd = 0;

        function getCursorWord() {
            const pos = editor.selectionStart;
            const txt = editor.value;
            let s = pos, e = pos;
            while (s > 0 && /[a-zA-Z0-9_.']/.test(txt[s-1])) s--;
            while (e < txt.length && /[a-zA-Z0-9_.']/.test(txt[e])) e++;
            return { word: txt.substring(s, e), start: s, end: e, pos };
        }

        function updateSuggestions() {
            const { word, start, end } = getCursorWord();
            curWord = word; wStart = start; wEnd = end;
            if (word.length < 1) { hideSuggestions(); return; }

            const upper = word.toUpperCase();
            const matches = [];

            completions.keywords.forEach(k => { if (k.name.startsWith(upper)) matches.push({ ...k, display:k.name, category:'Keywords' }); });
            completions.functions.forEach(f => { if (f.name.toUpperCase().startsWith(upper)) matches.push({ ...f, display:f.name, category:'Functions' }); });
            tables.forEach(t => { if (t.toLowerCase().startsWith(word.toLowerCase())) matches.push({ name:t, type:'table', desc:'Table', display:t, category:'Tables' }); });
            Object.entries(columns).forEach(([tbl, cols]) => cols.forEach(col => {
                if (col.toLowerCase().startsWith(word.toLowerCase())) matches.push({ name:col, type:'column', desc:`${tbl}.${col}`, display:col, category:'Columns' });
            }));
            completions.files.forEach(f => { if (f.name.toUpperCase().includes(upper)) matches.push({ ...f, display:f.name, category:'Files' }); });

            curMatches = matches.slice(0,10);
            curMatches.length ? showSuggestions(curMatches) : hideSuggestions();
        }

        function showSuggestions(list) {
            suggestionsBox.innerHTML = '';
            selIdx = 0;
            const groups = {};
            list.forEach(it => (groups[it.category] = groups[it.category] || []).push(it));

            Object.entries(groups).forEach(([cat, items]) => {
                const hdr = document.createElement('div');
                hdr.className = 'suggestion-header font-serif';
                hdr.textContent = cat;
                suggestionsBox.appendChild(hdr);
                items.forEach((it,i) => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    if (i===0 && Object.keys(groups).indexOf(cat)===0) div.classList.add('selected');

                    let ic = 'fa-key';
                    if (it.type==='table') ic='fa-table';
                    else if (it.type==='column') ic='fa-columns';
                    else if (it.type==='function') ic='fa-function';
                    else if (it.type==='file') ic='fa-file';

                    div.innerHTML = `
                        <div class="suggestion-icon"><i class="fas ${ic}"></i></div>
                        <div class="flex-1">
                            <div class="suggestion-title font-mono">${highlight(it.display,curWord)}</div>
                            <div class="suggestion-desc">${it.desc}</div>
                        </div>
                        ${i===0 && Object.keys(groups).indexOf(cat)===0 ? '<span class="suggestion-shortcut font-mono">Tab</span>' : ''}`;
                    div.onclick = () => accept(it);
                    suggestionsBox.appendChild(div);
                });
            });

            suggestionsBox.style.display = 'block';
            const lineCount = editor.value.substring(0, wStart).split('\n').length;
            suggestionsBox.style.top = `${lineCount * 20 + 60}px`;
            suggestionsBox.style.left = '20px';
        }

        function highlight(txt,q) {
            const idx = txt.toLowerCase().indexOf(q.toLowerCase());
            if (idx===-1) return txt;
            return txt.slice(0,idx)+`<span style="color: var(--oat-accent); font-weight:600;">${txt.slice(idx, idx+q.length)}</span>`+txt.slice(idx+q.length);
        }

        function hideSuggestions() { suggestionsBox.style.display='none'; selIdx=-1; curMatches=[]; }

        function accept(item) {
            const before = editor.value.substring(0,wStart);
            const after  = editor.value.substring(wEnd);
            editor.value = before + item.display + after;
            hideSuggestions();
            editor.focus();
            const newPos = wStart + item.display.length;
            editor.setSelectionRange(newPos,newPos);
        }

        editor.addEventListener('keydown', e => {
            if (e.key==='Tab' && suggestionsBox.style.display==='block') {
                e.preventDefault();
                accept(curMatches[selIdx]||curMatches[0]);
                return;
            }
            if (e.ctrlKey && e.key==='Enter') { executeQuery(); return; }

            if (suggestionsBox.style.display==='block') {
                const items = suggestionsBox.querySelectorAll('.suggestion-item');
                if (e.key==='ArrowDown') { e.preventDefault(); selIdx=(selIdx+1)%curMatches.length; updateSel(items); }
                else if (e.key==='ArrowUp') { e.preventDefault(); selIdx = selIdx<=0 ? curMatches.length-1 : selIdx-1; updateSel(items); }
                else if (e.key==='Enter' && selIdx>=0) { e.preventDefault(); accept(curMatches[selIdx]); }
                else if (e.key==='Escape') hideSuggestions();
            }
        });

        function updateSel(items) {
            items.forEach((el,i)=>{ el.classList.toggle('selected',i===selIdx); const sc=el.querySelector('.suggestion-shortcut'); if(sc) sc.textContent = i===selIdx?'Tab':''; });
        }

        editor.addEventListener('input', updateSuggestions);
        editor.addEventListener('blur', () => setTimeout(hideSuggestions,200));

        // ---------- QUERY EXECUTION ----------
        window.executeQuery = async function() {
            if (!conn) return;
            const sql = editor.value.trim();
            if (!sql) { showToast('Enter a query', 'warning', 2000); return; }

            toggleLoading(true);
            document.getElementById('errorState').classList.add('hidden');

            try {
                const t0 = performance.now();
                const result = await conn.query(sql);
                const ms = (performance.now() - t0).toFixed(0);
                renderResult(result, ms);
                currentResults = result;
                if (/CREATE|DROP|INSERT/i.test(sql)) refreshTables();
            } catch (err) {
                document.getElementById('errorText').textContent = err.message;
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('resultsTable').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
            }
            toggleLoading(false);
        };

        function renderResult(res, ms) {
            const table = document.getElementById('resultsTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            document.getElementById('emptyState').classList.add('hidden');
            table.classList.remove('hidden');
            thead.innerHTML=''; tbody.innerHTML='';

            const schema = res.schema;
            const rows = res.toArray();

            const tr = document.createElement('tr');
            schema.fields.forEach(f => {
                const th = document.createElement('th');
                th.className='px-3 py-2 text-left font-serif';
                th.innerHTML = `${f.name}<div class="text-[9px] opacity-60 font-normal mt-0.5 font-sans">${f.type}</div>`;
                tr.appendChild(th);
            });
            thead.appendChild(tr);

            rows.slice(0,1000).forEach((row,i)=>{
                const tr = document.createElement('tr');
                tr.style.background = i%2 ? 'var(--oat-warm)' : 'var(--oat-cream)';
                schema.fields.forEach(f => {
                    const td = document.createElement('td');
                    td.className='px-3 py-2 font-mono';
                    const v = row[f.name];
                    td.textContent = v===null ? 'NULL' : String(v);
                    if (v===null) td.style.color='var(--oat-stone)';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('resultStats').textContent = `${rows.length} rows • ${ms}ms`;
            document.getElementById('resultStats').classList.remove('hidden');
        }

        // ---------- TABLE LIST ----------
        window.refreshTables = async function() {
            if (!conn) return;
            const res = await conn.query(`SELECT table_name FROM information_schema.tables WHERE table_schema='main' ORDER BY table_name`);
            tables = res.toArray().map(r=>r.table_name);
            const list = document.getElementById('tableList');
            if (!tables.length) {
                list.innerHTML = '<div class="text-xs text-center py-8 italic font-serif" style="color: var(--oat-stone);">No tables</div>';
                return;
            }
            list.innerHTML = '';
            tables.forEach(t=>{
                const div=document.createElement('div');
                div.className='flex items-center gap-2 px-2 py-1.5 text-xs rounded cursor-pointer group transition-colors';
                div.style.color='var(--oat-charcoal)';
                div.innerHTML=`<i class="fas fa-table" style="color: var(--oat-stone);"></i><span class="font-mono">${t}</span>`;
                div.onclick=()=>selectTable(t);
                list.appendChild(div);
            });
        };
        window.filterTables = function(v){
            const lo=v.toLowerCase();
            document.querySelectorAll('#tableList > div').forEach(d=>{ d.style.display = d.textContent.toLowerCase().includes(lo) ? '' : 'none'; });
        };

        // ---------- UI UTILITIES ----------
        function toggleLoading(on){ document.getElementById('loadingState').classList.toggle('hidden',!on); }
        window.openHelp = ()=> document.getElementById('helpModal').classList.add('show');
        window.closeHelp = ()=> document.getElementById('helpModal').classList.remove('show');

        window.formatSQL = function() {
            let sql = editor.value;
            ['select','from','where','group by','order by','join','left','inner','on','and','or','with','create','table','insert','values','update','delete','drop']
                .forEach(k=>{ sql = sql.replace(new RegExp(`\\b${k}\\b`,'gi'), k.toUpperCase()); });
            editor.value = sql.replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|JOIN|WITH)\b/g,'\n$1').trim();
        };
        window.clearEditor = function(){ editor.value=''; hideSuggestions(); };

        window.copyResults = function() {
            if (!currentResults) return;
            const rows = currentResults.toArray();
            const schema = currentResults.schema;
            let txt = schema.fields.map(f=>f.name).join('\t') + '\n';
            rows.forEach(r=> txt += schema.fields.map(f=> r[f.name]===null ? '' : String(r[f.name])).join('\t') + '\n');
            navigator.clipboard.writeText(txt);
            showToast('Copied to clipboard', 'success', 2000);
        };
        window.exportCSV = function() {
            if (!currentResults) { showToast('No results', 'warning', 2000); return; }
            const rows = currentResults.toArray();
            const schema = currentResults.schema;
            let csv = schema.fields.map(f=>f.name).join(',') + '\n';
            rows.forEach(r=>{
                csv += schema.fields.map(f=>{
                    const v=r[f.name];
                    if (v===null) return '';
                    const s=String(v);
                    return s.includes(',')||s.includes('"') ? `"${s.replace(/"/g,'""')}"` : s;
                }).join(',') + '\n';
            });
            const blob = new Blob([csv],{type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `results_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported', 'success', 2000);
        };
    </script>
</body>
</html>
