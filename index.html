<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SQL Studio</title>

<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<link  rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/sql-hint.min.js"></script>
<link  rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

<!-- sql.js: SQLite compiled to WASM, runs on main thread ‚Äî NO Worker needed -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>

<!-- PapaParse for robust CSV/TSV parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0d0f14; --bg2:#13161e; --bg3:#1a1e2a; --bg4:#222636;
  --border:#2a2f42; --border2:#363d56;
  --text:#e2e6f0; --text2:#8b92aa; --text3:#565d78;
  --accent:#ffd166; --a2:#ff6b6b; --blue:#4ecdc4; --green:#06d6a0; --purple:#a78bfa;
  --ui:'Syne',sans-serif; --mono:'JetBrains Mono',monospace; --r:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--ui);background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* TOP */
#top{height:48px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0}
.logo{display:flex;align-items:center;gap:8px;font-weight:800;font-size:15px;letter-spacing:-.3px;color:var(--accent);text-transform:uppercase;white-space:nowrap}
.f1{flex:1}
.badge{font-family:var(--mono);font-size:11px;color:var(--text3);background:var(--bg3);border:1px solid var(--border);padding:3px 8px;border-radius:4px}
#sdot{width:7px;height:7px;border-radius:50%;background:var(--text3);transition:background .3s;flex-shrink:0}
#sdot.ready{background:var(--green);box-shadow:0 0 6px var(--green)}
#sdot.busy{background:var(--accent);animation:pulse 1s infinite}
#sdot.err{background:var(--a2)}
#slbl{font-size:12px;color:var(--text2)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* LAYOUT */
#main{display:flex;flex:1;overflow:hidden}

/* SIDEBAR */
#sidebar{width:260px;min-width:180px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.stabs{display:flex;border-bottom:1px solid var(--border)}
.stab{flex:1;padding:10px 0;text-align:center;font-size:11px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.stab:hover{color:var(--text2)}
.stab.on{color:var(--accent);border-bottom-color:var(--accent)}
.spanel{display:none;flex:1;flex-direction:column;overflow:hidden}
.spanel.on{display:flex}

#dropz{margin:12px;border:1.5px dashed var(--border2);border-radius:var(--r);padding:18px 12px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg3);flex-shrink:0}
#dropz:hover,#dropz.over{border-color:var(--accent);background:rgba(255,209,102,.05)}
.dico{font-size:22px;margin-bottom:5px}
.dlbl{font-size:12px;color:var(--text2)}
.dsub{font-size:10px;color:var(--text3);margin-top:3px;font-family:var(--mono)}
#finput{display:none}

#tsrch{margin:8px;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:var(--mono);font-size:12px;width:calc(100% - 16px);outline:none;flex-shrink:0}
#tsrch:focus{border-color:var(--accent)}
#tsrch::placeholder{color:var(--text3)}

#tlist{flex:1;overflow-y:auto;padding:4px 6px 8px}
#tlist::-webkit-scrollbar{width:4px}
#tlist::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

.ti{border-radius:var(--r);margin-bottom:4px;border:1px solid transparent;transition:border-color .15s;background:var(--bg3)}
.ti.sel{border-color:var(--accent)}
.th2{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:var(--r) var(--r) 0 0;transition:background .15s}
.th2:hover{background:var(--bg4)}
.tn{font-size:12px;font-weight:600;color:var(--text);flex:1;font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.trc{font-size:10px;color:var(--text3);font-family:var(--mono);white-space:nowrap}
.tact{display:flex;gap:4px;padding:0 8px 8px}
.tbtn{flex:1;padding:4px 2px;border:1px solid var(--border2);background:var(--bg2);color:var(--text2);font-size:10px;font-family:var(--ui);font-weight:600;border-radius:4px;cursor:pointer;transition:all .15s}
.tbtn:hover{background:var(--bg4);color:var(--text);border-color:var(--accent)}
.tbtn.d{color:var(--a2)}
.tbtn.d:hover{border-color:var(--a2);background:rgba(255,107,107,.1)}
.scols{padding:0 8px 8px}
.scol{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:4px;font-family:var(--mono);font-size:11px}
.scol:hover{background:var(--bg4)}
.sname{color:var(--text2);flex:1}
.stype{font-size:10px;color:var(--purple)}
.sempty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--text3);font-size:12px;gap:6px;padding:20px;text-align:center}
.sempty .ei{font-size:28px;opacity:.4}

#hlist{flex:1;overflow-y:auto;padding:6px}
.hi{padding:8px 10px;border-radius:var(--r);cursor:pointer;margin-bottom:3px;border:1px solid transparent;transition:all .15s}
.hi:hover{background:var(--bg3);border-color:var(--border)}
.hsql{font-family:var(--mono);font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hmeta{font-size:10px;color:var(--text3);margin-top:3px;display:flex;gap:8px}
.ok{color:var(--green)} .er{color:var(--a2)}

.slbl{padding:8px 12px 4px;font-size:10px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--text3)}
.snips{flex:1;overflow-y:auto}
.snip{margin:4px 8px;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all .15s}
.snip:hover{border-color:var(--accent);background:rgba(255,209,102,.05)}
.st{font-size:11px;font-weight:600;color:var(--text2)}
.ss{font-family:var(--mono);font-size:10px;color:var(--text3);margin-top:3px}

#sresz{width:4px;background:transparent;cursor:col-resize;flex-shrink:0;transition:background .15s}
#sresz:hover{background:var(--accent)}

/* CONTENT */
#content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

#qtabs{display:flex;align-items:center;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 8px;gap:2px;overflow-x:auto;flex-shrink:0;height:38px}
#qtabs::-webkit-scrollbar{display:none}
.qtab{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:5px 5px 0 0;font-size:12px;cursor:pointer;color:var(--text3);white-space:nowrap;transition:all .15s;border:1px solid transparent;border-bottom:none;position:relative;top:1px}
.qtab:hover{color:var(--text2);background:var(--bg3)}
.qtab.on{color:var(--text);background:var(--bg);border-color:var(--border)}
.qx{width:14px;height:14px;display:flex;align-items:center;justify-content:center;border-radius:3px;font-size:10px;opacity:0;transition:opacity .15s}
.qtab:hover .qx{opacity:1}
.qx:hover{background:rgba(255,107,107,.2);color:var(--a2)}
#addtab{width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:5px;cursor:pointer;color:var(--text3);font-size:16px;transition:all .15s;border:1px solid transparent;margin-left:4px}
#addtab:hover{background:var(--bg3);color:var(--accent);border-color:var(--border)}

#etbar{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.tlbl{font-size:10px;color:var(--text3);font-weight:600;letter-spacing:.5px;text-transform:uppercase}
.btn{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:var(--r);font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);font-family:var(--ui);transition:all .15s;white-space:nowrap}
.btn:hover:not(:disabled){background:var(--bg4);color:var(--text)}
.btn:disabled{opacity:.5;cursor:not-allowed}
#runbtn{background:var(--accent);color:#0d0f14;border-color:var(--accent)}
#runbtn:hover:not(:disabled){background:#ffdb80}
.kb{font-family:var(--mono);font-size:9px;background:rgba(0,0,0,.2);padding:1px 4px;border-radius:3px;opacity:.7}
#lsel{padding:4px 6px;border-radius:var(--r);background:var(--bg3);border:1px solid var(--border2);color:var(--text2);font-family:var(--mono);font-size:11px;cursor:pointer;outline:none}

#edbox{height:200px;overflow:hidden;flex-shrink:0}
.CodeMirror{height:100%!important;font-family:var(--mono)!important;font-size:13px!important;line-height:1.6!important;background:var(--bg)!important;color:var(--text)!important}
.CodeMirror-gutters{background:var(--bg2)!important;border-right:1px solid var(--border)!important}
.CodeMirror-linenumber{color:var(--text3)!important}
.CodeMirror-cursor{border-left-color:var(--accent)!important}
.CodeMirror-selected{background:rgba(255,209,102,.12)!important}
.CodeMirror-activeline-background{background:rgba(255,255,255,.02)!important}
.cm-keyword{color:var(--accent)!important;font-weight:600}
.cm-builtin{color:var(--blue)!important}
.cm-string{color:var(--green)!important}
.cm-number{color:var(--purple)!important}
.cm-comment{color:var(--text3)!important;font-style:italic}
.CodeMirror-hints{background:var(--bg3)!important;border:1px solid var(--border2)!important;border-radius:var(--r)!important}
.CodeMirror-hint{color:var(--text)!important;font-family:var(--mono)!important;font-size:12px!important}
.CodeMirror-hint-active{background:var(--accent)!important;color:#0d0f14!important}

#rhandle{height:5px;background:var(--bg2);border-top:1px solid var(--border);border-bottom:1px solid var(--border);cursor:ns-resize;display:flex;align-items:center;justify-content:center;flex-shrink:0;user-select:none;transition:background .15s}
#rhandle:hover{background:var(--bg4)}
#rhandle::before{content:'‚ãØ';color:var(--text3);font-size:12px}

#rpane{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
#rtbar{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:nowrap;min-height:40px}
#rmeta{font-family:var(--mono);font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1}
.rf1{flex:1;min-width:8px}
#rfilter{padding:5px 10px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);color:var(--text2);font-family:var(--mono);font-size:11px;outline:none;width:200px;transition:border-color .15s;flex-shrink:0}
#rfilter:focus{border-color:var(--accent)}
#rfilter::placeholder{color:var(--text3)}
#vtog{display:flex;border:1px solid var(--border2);border-radius:var(--r);overflow:hidden;flex-shrink:0}
.vbtn{padding:4px 10px;font-size:11px;cursor:pointer;color:var(--text3);background:var(--bg3);border:none;font-family:var(--ui);font-weight:600;transition:all .15s}
.vbtn.on{background:var(--accent);color:#0d0f14}
.vbtn:not(.on):hover{background:var(--bg4);color:var(--text2)}

#rcont{flex:1;overflow:auto;position:relative}
#rcont::-webkit-scrollbar{width:6px;height:6px}
#rcont::-webkit-scrollbar-track{background:var(--bg2)}
#rcont::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

#ph{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text3);gap:10px}
.phico{font-size:36px;opacity:.3}

#loading{display:none;position:absolute;inset:0;background:rgba(13,15,20,.7);align-items:center;justify-content:center;z-index:10}
#loading.on{display:flex}
.spin{width:30px;height:30px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

#dtable{display:none}
#dtable.on{display:block}
.rt{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px}
.rt thead{position:sticky;top:0;z-index:5}
.rt th{background:var(--bg3);color:var(--text2);padding:8px 12px;text-align:left;font-weight:600;font-size:11px;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
.rt th:hover{background:var(--bg4);color:var(--text)}
.ctype{font-size:9px;color:var(--purple);display:block;font-weight:400;margin-top:1px}
.sarr{opacity:.3;margin-left:3px;font-size:10px;display:inline-block}
.sasc .sarr{opacity:1} .sdsc .sarr{opacity:1;transform:scaleY(-1)}
.rt td{padding:6px 12px;border-bottom:1px solid rgba(42,47,66,.4);color:var(--text);white-space:nowrap;max-width:320px;overflow:hidden;text-overflow:ellipsis}
.rt tr:hover td{background:var(--bg3)}
.vnull{color:var(--text3)!important;font-style:italic}
.vnum{color:var(--purple)!important}
.vbool{color:var(--blue)!important}
.rt td:first-child,.rt th:first-child{color:var(--text3);font-size:10px;text-align:right;padding-right:14px;background:var(--bg2);position:sticky;left:0;min-width:48px;border-right:1px solid var(--border)}

#pager{display:flex;align-items:center;gap:8px;padding:7px 12px;background:var(--bg2);border-top:1px solid var(--border);font-size:12px;color:var(--text3);flex-shrink:0}
.pbtn{padding:3px 10px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);border-radius:4px;cursor:pointer;font-family:var(--ui);font-size:11px;font-weight:600;transition:all .15s}
.pbtn:hover:not(:disabled){background:var(--bg4);color:var(--text)}
.pbtn:disabled{opacity:.3;cursor:not-allowed}

#jview{display:none;padding:12px;overflow:auto;height:100%}
#jview.on{display:block}
#jpre{font-family:var(--mono);font-size:12px;color:var(--text);line-height:1.6;white-space:pre-wrap;word-break:break-all}

/* ‚îÄ‚îÄ IMPORT PROGRESS ‚îÄ‚îÄ */
#import-progress{
  display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);
  padding:12px 18px;z-index:9998;min-width:320px;max-width:480px;
  box-shadow:0 4px 20px rgba(0,0,0,.5);
}
#import-progress.on{display:block}
.prog-title{font-size:12px;color:var(--text2);margin-bottom:8px;font-family:var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prog-bar-wrap{height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;margin-bottom:6px}
.prog-bar{height:100%;background:var(--accent);border-radius:3px;transition:width .1s;width:0%}
.prog-sub{font-size:10px;color:var(--text3);font-family:var(--mono)}
#toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);padding:10px 16px;font-size:12px;color:var(--text);z-index:9999;opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;max-width:340px}
#toast.on{opacity:1;transform:translateY(0)}
#toast.ok{border-color:var(--green)}
#toast.er{border-color:var(--a2)}
</style>
</head>
<body>

<div id="top">
  <div class="logo">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
      <circle cx="10" cy="10" r="9" fill="#ffd166" opacity="0.15"/>
      <ellipse cx="10" cy="10" rx="7" ry="4" stroke="#ffd166" stroke-width="1.5"/>
      <line x1="3" y1="10" x2="17" y2="10" stroke="#ffd166" stroke-width="1.5"/>
      <ellipse cx="10" cy="10" rx="7" ry="4" stroke="#ffd166" stroke-width="1.5" transform="rotate(60 10 10)"/>
    </svg>
    SQL Studio
  </div>
  <div class="f1"></div>
  <div class="badge" id="ver">loading‚Ä¶</div>
  <div id="sdot" class="busy"></div>
  <span id="slbl">Initializing‚Ä¶</span>
</div>

<div id="main">
  <div id="sidebar">
    <div class="stabs">
      <div class="stab on" data-p="tp">Tables</div>
      <div class="stab"    data-p="hp">History</div>
      <div class="stab"    data-p="snp">Snippets</div>
    </div>

    <!-- TABLES PANEL -->
    <div class="spanel on" id="tp">
      <div id="dropz">
        <div class="dico">üìÇ</div>
        <div class="dlbl">Drop files or click to import</div>
        <div class="dsub">CSV ¬∑ CSV.GZ ¬∑ TSV ¬∑ JSON</div>
        <input type="file" id="finput" multiple accept=".csv,.tsv,.json,.gz,.csv.gz">
      </div>
      <input type="text" id="tsrch" placeholder="Filter tables‚Ä¶">
      <div id="tlist">
        <div class="sempty" id="noTbl">
          <span class="ei">ü¶Ü</span>
          <span>No tables yet.</span>
          <span>Import a file to start.</span>
        </div>
      </div>
    </div>

    <!-- HISTORY PANEL -->
    <div class="spanel" id="hp">
      <div class="slbl">Query History</div>
      <div id="hlist">
        <div class="sempty"><span class="ei">üìã</span><span>No history yet.</span></div>
      </div>
    </div>

    <!-- SNIPPETS PANEL -->
    <div class="spanel" id="snp">
      <div class="slbl">SQL Snippets</div>
      <div class="snips">
        <div class="snip" data-sql="SELECT sqlite_version();"><div class="st">SQLite Version</div><div class="ss">SELECT sqlite_version();</div></div>
        <div class="snip" data-sql="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"><div class="st">List All Tables</div><div class="ss">sqlite_master</div></div>
        <div class="snip" data-sql="PRAGMA table_info('TABLE');"><div class="st">Table Schema</div><div class="ss">PRAGMA table_info</div></div>
        <div class="snip" data-sql="SELECT COUNT(*) as total_rows FROM TABLE;"><div class="st">Row Count</div><div class="ss">COUNT(*)</div></div>
        <div class="snip" data-sql="SELECT * FROM TABLE LIMIT 100;"><div class="st">Preview Table</div><div class="ss">SELECT * LIMIT 100</div></div>
        <div class="snip" data-sql="SELECT col, COUNT(*) as n\nFROM TABLE\nGROUP BY col\nORDER BY n DESC\nLIMIT 20;"><div class="st">Value Counts</div><div class="ss">GROUP BY ‚Ä¶ ORDER BY n DESC</div></div>
        <div class="snip" data-sql="SELECT\n  MIN(col) as min_val,\n  MAX(col) as max_val,\n  ROUND(AVG(col),2) as avg_val,\n  SUM(col) as total\nFROM TABLE;"><div class="st">Numeric Summary</div><div class="ss">MIN / MAX / AVG / SUM</div></div>
        <div class="snip" data-sql="SELECT\n  COUNT(*) as total,\n  COUNT(DISTINCT col) as unique_vals,\n  SUM(CASE WHEN col IS NULL THEN 1 ELSE 0 END) as nulls\nFROM TABLE;"><div class="st">Column Stats</div><div class="ss">COUNT / DISTINCT / NULLs</div></div>
        <div class="snip" data-sql="SELECT * FROM TABLE ORDER BY RANDOM() LIMIT 10;"><div class="st">Random Sample</div><div class="ss">ORDER BY RANDOM()</div></div>
        <div class="snip" data-sql="SELECT a.*, b.col\nFROM TABLE a\nJOIN other_table b ON a.id = b.id;"><div class="st">JOIN Tables</div><div class="ss">JOIN ‚Ä¶ ON</div></div>
        <div class="snip" data-sql="WITH cte AS (\n  SELECT *, ROW_NUMBER() OVER (PARTITION BY col ORDER BY col2 DESC) as rn\n  FROM TABLE\n)\nSELECT * FROM cte WHERE rn = 1;"><div class="st">Window: Top per Group</div><div class="ss">ROW_NUMBER() OVER PARTITION</div></div>
      </div>
    </div>
  </div>

  <div id="sresz"></div>

  <div id="content">
    <div id="qtabs">
      <div class="qtab on" data-tab="0"><span>Query 1</span><span class="qx">√ó</span></div>
      <div id="addtab" title="New tab">+</div>
    </div>

    <div id="etbar">
      <span class="tlbl">SQL Editor</span>
      <div class="f1"></div>
      <select id="lsel">
        <option value="100">Limit 100</option>
        <option value="500">Limit 500</option>
        <option value="1000">Limit 1000</option>
        <option value="5000">Limit 5000</option>
        <option value="">No limit</option>
      </select>
      <button class="btn" id="fmtbtn">‚å• Format</button>
      <button class="btn" id="clrbtn">Clear</button>
      <button class="btn" id="runbtn" disabled>‚ñ∂ Run <span class="kb">Ctrl+‚Üµ</span></button>
    </div>
    <div id="edbox"></div>

    <div id="rhandle"></div>

    <div id="rpane">
      <div id="rtbar">
        <span id="rmeta">No results</span>
        <div class="rf1"></div>
        <input type="text" id="rfilter" placeholder="Filter‚Ä¶ (>=100, MCX, >0)" style="display:none" title="Supports: text search, >=100, <=50, >0, <1000, =MCX, !=0">
        <div id="vtog" style="display:none">
          <button class="vbtn on" data-v="table">Table</button>
          <button class="vbtn"    data-v="json">JSON</button>
        </div>
        <button class="btn" id="csvbtn" style="display:none">‚¨á CSV</button>
        <button class="btn" id="cpybtn" style="display:none">Copy</button>
      </div>
      <div id="rcont">
        <div id="loading"><div class="spin"></div></div>
        <div id="ph">
          <div class="phico">ü¶Ü</div>
          <div style="font-size:13px">Ready to query</div>
          <div style="font-size:11px;font-family:var(--mono)">Write SQL above ¬∑ Ctrl+Enter to run</div>
        </div>
        <div id="dtable"></div>
        <div id="jview"><pre id="jpre"></pre></div>
      </div>
      <div id="pager" style="display:none">
        <button class="pbtn" id="pprev">‚Üê Prev</button>
        <span id="pinfo"></span>
        <div style="flex:1"></div>
        <span id="pcount"></span>
        <button class="pbtn" id="pnext">Next ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<div id="import-progress">
  <div class="prog-title" id="prog-title">Importing‚Ä¶</div>
  <div class="prog-bar-wrap"><div class="prog-bar" id="prog-bar"></div></div>
  <div class="prog-sub" id="prog-sub"></div>
</div>
<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let DB      = null;
let tables  = {};          // name -> {rowCount, columns:[{name,type}]}
let hist    = [];
let res     = null;        // {cols, rows, filtered}
let pg      = 0;
const PAGE  = 200;
let sCol    = -1, sDir = 1;
let actTab  = 0, tabN = 1;
let editors = {};          // tabId -> CodeMirror

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT  ‚Äî  sql.js runs on main thread, no Worker at all
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  try {
    const SQL = await initSqlJs({
      locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
    });
    DB = new SQL.Database();
    setStatus('ready','Ready');
    document.getElementById('ver').textContent = 'SQLite (sql.js v1.10)';
    document.getElementById('runbtn').disabled = false;
    refreshSidebar();
    toast('Engine ready ‚Äî drop a file to import ‚úì','ok');
  } catch(e) {
    setStatus('err','Init failed');
    toast('Init error: '+e.message,'er');
    console.error(e);
  }
}

function setStatus(t,l){ document.getElementById('sdot').className=t; document.getElementById('slbl').textContent=l; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TYPE INFERENCE  ‚Üê Fixes "everything is Utf8 / Text"
//   Samples up to 300 values per column, votes on best type
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function inferColType(values) {
  const samp = values.filter(v => v!=null && String(v).trim()!=='').slice(0,300);
  if (!samp.length) return 'TEXT';
  let ints=0, reals=0, bools=0, dates=0;
  const rInt  = /^-?\d{1,15}$/;
  const rReal = /^-?(\d+\.?\d*|\.\d+)([eE][+-]?\d+)?$/;
  const rBool = /^(true|false|yes|no|1|0)$/i;
  const rDate = /^\d{4}-\d{2}-\d{2}([ T]\d{2}:\d{2}(:\d{2})?(\.\d+)?)?Z?$/;
  for (const v of samp) {
    const s = String(v).trim().replace(/,/g,''); // strip thousands commas
    if (rBool.test(s))       bools++;
    else if (rDate.test(s))  dates++;
    else if (rInt.test(s))   ints++;
    else if (rReal.test(s))  reals++;
  }
  const n = samp.length;
  if (ints/n  >= 0.85) return 'INTEGER';
  if ((ints+reals)/n >= 0.85) return 'REAL';
  if (bools/n >= 0.85) return 'INTEGER'; // store as 0/1
  if (dates/n >= 0.80) return 'TEXT';    // store as text, preserve format
  return 'TEXT';
}

// Cast a raw CSV string to the right JS value for sql.js
function castVal(v, type) {
  if (v===null||v===undefined||String(v).trim()==='') return null;
  const s = String(v).trim();
  if (type==='INTEGER') {
    // Handle comma-formatted numbers like "1,000"
    const cleaned = s.replace(/,/g,'');
    const n = parseInt(cleaned, 10);
    return isNaN(n) ? null : n;
  }
  if (type==='REAL') {
    const cleaned = s.replace(/,/g,'');
    const n = parseFloat(cleaned);
    return isNaN(n) ? null : n;
  }
  return s;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const dz = document.getElementById('dropz');
const fi = document.getElementById('finput');
dz.addEventListener('click', ()=> fi.click());
fi.addEventListener('change', e=>{ readAndImport([...e.target.files]); fi.value=''; });
dz.addEventListener('dragover',  e=>{ e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', ()=> dz.classList.remove('over'));
dz.addEventListener('drop', e=>{ e.preventDefault(); dz.classList.remove('over'); readAndImport([...e.dataTransfer.files]); });

// CRITICAL: read all bytes immediately inside the event handler BEFORE any awaits.
// File handles go stale after the event loop tick on large files.
async function readAndImport(files) {
  const items = files.map(f => ({
    name: f.name,
    size: f.size,
    bufferPromise: f.arrayBuffer()
  }));
  for (const item of items) {
    await importOne(item);
  }
  refreshSidebar();
  setStatus('ready','Ready');
}

// ‚îÄ‚îÄ PROGRESS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showProgress(title, pct, sub) {
  const el = document.getElementById('import-progress');
  el.className = 'on';
  document.getElementById('prog-title').textContent = title;
  document.getElementById('prog-bar').style.width = pct + '%';
  document.getElementById('prog-sub').textContent  = sub;
}
function hideProgress() {
  document.getElementById('import-progress').className = '';
}
// Yield to browser so UI can update between chunks
function yieldToBrowser() {
  return new Promise(r => setTimeout(r, 0));
}
function fmtBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

// ‚îÄ‚îÄ STREAMING GUNZIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Decompresses in streaming fashion and returns text without
// building one giant concatenated Uint8Array first
async function gunzip(arrayBuffer) {
  showProgress('Decompressing‚Ä¶', 5, fmtBytes(arrayBuffer.byteLength) + ' compressed');
  await yieldToBrowser();
  const ds     = new DecompressionStream('gzip');
  const writer = ds.writable.getWriter();
  // Feed in 4 MB chunks so the browser stays responsive
  const CHUNK = 4 * 1024 * 1024;
  const src   = new Uint8Array(arrayBuffer);
  for (let i = 0; i < src.length; i += CHUNK) {
    writer.write(src.slice(i, i + CHUNK));
    showProgress('Decompressing‚Ä¶', 5 + Math.round((i / src.length) * 20),
      fmtBytes(i) + ' / ' + fmtBytes(src.length));
    await yieldToBrowser();
  }
  writer.close();
  // Collect decoded output chunks
  const reader = ds.readable.getReader();
  const chunks = [];
  let totalBytes = 0;
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
    totalBytes += value.length;
  }
  showProgress('Decoding text‚Ä¶', 25, fmtBytes(totalBytes) + ' decompressed');
  await yieldToBrowser();
  // Decode all chunks at once (TextDecoder handles multi-byte chars correctly)
  const blob = new Blob(chunks);
  return blob.text();
}

// ‚îÄ‚îÄ IMPORT ENTRY POINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// item = {name, size, bufferPromise} ‚Äî bytes already reading in background
async function importOne(item) {
  if (!DB) { toast('DB not ready','er'); return; }
  const fname = item.name.toLowerCase();
  const isGz  = fname.endsWith('.gz');
  const base  = item.name
    .replace(/\.gz$/i,'').replace(/\.[^.]+$/,'')
    .replace(/[^a-zA-Z0-9_]/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,'') || 'table';

  let tname = base, n = 2;
  const existing = DB.exec("SELECT name FROM sqlite_master WHERE type='table'");
  const taken = new Set(existing.length ? existing[0].values.map(r=>r[0]) : []);
  while (taken.has(tname)) tname = base+'_'+n++;

  showProgress('Reading ' + item.name + '...', 2, fmtBytes(item.size));
  setStatus('busy','Importing...');
  try {
    // Await the buffer that started reading back in readAndImport()
    const arrayBuf = await item.bufferPromise;

    let text;
    if (isGz) {
      text = await gunzip(arrayBuf);
    } else {
      showProgress('Decoding ' + item.name + '...', 15, fmtBytes(item.size));
      await yieldToBrowser();
      text = new TextDecoder().decode(arrayBuf);
    }

    const inner = fname.replace(/\.gz$/, '');
    const ext   = inner.split('.').pop();

    if (ext === 'json')      await importJSON(text, tname);
    else if (ext === 'tsv')  await importCSV(text, tname, '\t');
    else                     await importCSV(text, tname, ',');

    const cnt = DB.exec('SELECT COUNT(*) FROM "' + tname + '"');
    const rowCount = cnt.length ? cnt[0].values[0][0] : 0;
    hideProgress();
    toast('Loaded "' + tname + '" - ' + Number(rowCount).toLocaleString() + ' rows', 'ok');
    setStatus('busy','Loading...');
    ed().setValue('SELECT * FROM "' + tname + '" LIMIT 100;');
  } catch(e) {
    hideProgress();
    toast('Import failed: ' + e.message.slice(0,120), 'er');
    setStatus('ready','Error');
    console.error(e);
  }
}

// ‚îÄ‚îÄ CSV IMPORT ‚Äî chunked inserts, yields every 5000 rows ‚îÄ
async function importCSV(text, tname, delim=',') {
  showProgress('Parsing CSV‚Ä¶', 28, '');
  await yieldToBrowser();

  // Use PapaParse streaming: header from first chunk only
  const parsed = Papa.parse(text, {
    header: true, skipEmptyLines: 'greedy', delimiter: delim, dynamicTyping: false
  });
  if (!parsed.data.length) throw new Error('No rows found');
  const cols = parsed.meta.fields.filter(Boolean);
  if (!cols.length) throw new Error('No columns found');

  const total = parsed.data.length;
  showProgress('Inferring column types‚Ä¶', 32, `${total.toLocaleString()} rows`);
  await yieldToBrowser();

  // Sample 500 evenly-spaced rows for type inference (fast + representative)
  const step   = Math.max(1, Math.floor(total / 500));
  const sample = [];
  for (let i = 0; i < total; i += step) sample.push(parsed.data[i]);
  const types = {};
  cols.forEach(c => { types[c] = inferColType(sample.map(r => r[c])); });

  const defs = cols.map(c => `"${c.replace(/"/g,'""')}" ${types[c]}`).join(',');
  DB.run(`CREATE TABLE IF NOT EXISTS "${tname}" (${defs})`);

  const ph   = cols.map(() => '?').join(',');
  const stmt = DB.prepare(`INSERT INTO "${tname}" VALUES (${ph})`);

  // Insert in chunks of 5000 rows per transaction, yield between each chunk
  const CHUNK = 5000;
  let inserted = 0;
  try {
    while (inserted < total) {
      const end   = Math.min(inserted + CHUNK, total);
      const pct   = 35 + Math.round((inserted / total) * 60);
      showProgress(
        `Inserting rows‚Ä¶ ${inserted.toLocaleString()} / ${total.toLocaleString()}`,
        pct,
        `chunk ${Math.floor(inserted/CHUNK)+1} / ${Math.ceil(total/CHUNK)}`
      );
      await yieldToBrowser();

      DB.run('BEGIN TRANSACTION');
      for (let i = inserted; i < end; i++) {
        stmt.run(cols.map(c => castVal(parsed.data[i][c], types[c])));
      }
      DB.run('COMMIT');
      inserted = end;
    }
  } catch(e) {
    try { DB.run('ROLLBACK'); } catch(_) {}
    throw e;
  } finally {
    stmt.free();
  }
  showProgress('Finalizing‚Ä¶', 97, `${total.toLocaleString()} rows inserted`);
  await yieldToBrowser();
}

// ‚îÄ‚îÄ JSON IMPORT ‚Äî chunked ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function importJSON(text, tname) {
  showProgress('Parsing JSON‚Ä¶', 28, '');
  await yieldToBrowser();

  let data = JSON.parse(text);
  if (!Array.isArray(data)) {
    const key = Object.keys(data).find(k => Array.isArray(data[k]));
    if (key) data = data[key];
    else throw new Error('JSON must be an array or have an array property');
  }
  if (!data.length) throw new Error('Empty JSON array');

  const total = data.length;
  const cols  = [...new Set(data.flatMap(Object.keys))];

  showProgress('Inferring column types‚Ä¶', 32, `${total.toLocaleString()} rows`);
  await yieldToBrowser();

  const step   = Math.max(1, Math.floor(total / 500));
  const sample = [];
  for (let i = 0; i < total; i += step) sample.push(data[i]);
  const types = {};
  cols.forEach(c => { types[c] = inferColType(sample.map(r => r[c] ?? null)); });

  const defs = cols.map(c => `"${c.replace(/"/g,'""')}" ${types[c]}`).join(',');
  DB.run(`CREATE TABLE IF NOT EXISTS "${tname}" (${defs})`);

  const ph   = cols.map(() => '?').join(',');
  const stmt = DB.prepare(`INSERT INTO "${tname}" VALUES (${ph})`);

  const CHUNK = 5000;
  let inserted = 0;
  try {
    while (inserted < total) {
      const end = Math.min(inserted + CHUNK, total);
      const pct = 35 + Math.round((inserted / total) * 60);
      showProgress(
        `Inserting rows‚Ä¶ ${inserted.toLocaleString()} / ${total.toLocaleString()}`,
        pct,
        `chunk ${Math.floor(inserted/CHUNK)+1} / ${Math.ceil(total/CHUNK)}`
      );
      await yieldToBrowser();

      DB.run('BEGIN TRANSACTION');
      for (let i = inserted; i < end; i++) {
        stmt.run(cols.map(c => castVal(data[i][c] ?? null, types[c])));
      }
      DB.run('COMMIT');
      inserted = end;
    }
  } catch(e) {
    try { DB.run('ROLLBACK'); } catch(_) {}
    throw e;
  } finally {
    stmt.free();
  }
  showProgress('Finalizing‚Ä¶', 97, `${total.toLocaleString()} rows inserted`);
  await yieldToBrowser();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR  ‚Äî stable rebuild, noTbl never destroyed
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshSidebar(filter='') {
  if (!DB) return;
  // Read tables directly from DB every time
  const r = DB.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
  const names = r.length ? r[0].values.map(v=>v[0]) : [];
  tables = {};
  for (const nm of names) {
    try {
      const cnt  = DB.exec(`SELECT COUNT(*) FROM "${nm}"`);
      const info = DB.exec(`PRAGMA table_info("${nm}")`);
      tables[nm] = {
        rowCount: cnt[0].values[0][0],
        columns:  info[0] ? info[0].values.map(row=>({name:row[1], type:row[2]||'TEXT'})) : []
      };
    } catch(e) { tables[nm] = { rowCount:'?', columns:[] }; }
  }
  renderTList(filter || document.getElementById('tsrch').value || '');
}

function renderTList(filter='') {
  const list = document.getElementById('tlist');
  const f    = filter.toLowerCase();
  const names = Object.keys(tables).filter(n => n.toLowerCase().includes(f));

  // ‚îÄ‚îÄ Key fix: remove only .ti elements, never touch #noTbl ‚îÄ‚îÄ
  list.querySelectorAll('.ti').forEach(el => el.remove());

  const noMsg = document.getElementById('noTbl');
  if (!names.length) {
    noMsg.style.display = 'flex';
    return;
  }
  noMsg.style.display = 'none';

  names.forEach(nm => {
    const t   = tables[nm];
    const div = document.createElement('div');
    div.className = 'ti';
    div.innerHTML = `
      <div class="th2">
        <span style="font-size:13px">üìã</span>
        <span class="tn" title="${esc(nm)}">${esc(nm)}</span>
        <span class="trc">${Number(t.rowCount).toLocaleString()}</span>
      </div>
      <div class="tact">
        <button class="tbtn" data-a="preview">Preview</button>
        <button class="tbtn" data-a="schema">Schema</button>
        <button class="tbtn" data-a="count">Count</button>
        <button class="tbtn d" data-a="drop">Drop</button>
      </div>`;

    div.querySelector('.th2').addEventListener('click', ()=>{
      div.classList.toggle('sel');
      const ex = div.querySelector('.scols');
      if (ex) { ex.remove(); return; }
      const sc = document.createElement('div');
      sc.className = 'scols';
      t.columns.forEach(col=>{
        const el = document.createElement('div');
        el.className = 'scol';
        el.innerHTML = `<span class="sname">${esc(col.name)}</span><span class="stype">${esc(col.type)}</span>`;
        el.addEventListener('click', e=>{ e.stopPropagation(); insertText(col.name); });
        sc.appendChild(el);
      });
      div.appendChild(sc);
    });

    div.querySelectorAll('.tbtn').forEach(btn=>{
      btn.addEventListener('click', e=>{ e.stopPropagation(); tAction(btn.dataset.a, nm); });
    });
    list.appendChild(div);
  });
}

function tAction(action, nm) {
  const e = ed();
  if (action==='preview')    { e.setValue(`SELECT * FROM "${nm}" LIMIT 100;`); runQ(); }
  else if (action==='schema'){ e.setValue(`PRAGMA table_info("${nm}");`); runQ(); }
  else if (action==='count') { e.setValue(`SELECT COUNT(*) as total_rows FROM "${nm}";`); runQ(); }
  else if (action==='drop')  {
    if (!confirm(`Drop table "${nm}"? Cannot be undone.`)) return;
    try { DB.run(`DROP TABLE IF EXISTS "${nm}"`); toast(`Dropped "${nm}"`,'ok'); refreshSidebar(); }
    catch(e){ toast(e.message,'er'); }
  }
}

function insertText(t) {
  const cm = ed();
  const cur = cm.getCursor();
  cm.replaceRange(t, cur);
  cm.focus();
}

document.getElementById('tsrch').addEventListener('input', e=>renderTList(e.target.value || ''));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkEditor(container) {
  const cm = CodeMirror(container, {
    mode:'text/x-sql', theme:'default', lineNumbers:true,
    matchBrackets:true, autoCloseBrackets:true, autofocus:true,
    indentUnit:2, tabSize:2, smartIndent:true, lineWrapping:false,
    extraKeys:{
      'Ctrl-Enter': runQ, 'Cmd-Enter': runQ,
      'Ctrl-Space': 'autocomplete',
      'Tab': cm => cm.somethingSelected() ? cm.indentSelection('add') : cm.replaceSelection('  ')
    },
    hintOptions:{ completeSingle:false }
  });
  cm.on('inputRead', (cm,ch)=>{
    if (!cm.state.completionActive && /\w/.test(ch.text[0]))
      CodeMirror.commands.autocomplete(cm,null,{completeSingle:false});
  });
  return cm;
}

const edbox = document.getElementById('edbox');
editors[0] = mkEditor(edbox);
editors[0].setValue('-- Welcome to SQL Studio!\n-- Drop a CSV, CSV.GZ, TSV, or JSON file to import it.\n-- Then query it below.\n\n-- Example after import:\n-- SELECT * FROM your_table LIMIT 100;\n-- SELECT exchange, COUNT(*) FROM your_table GROUP BY exchange;');

function ed() { return editors[actTab]; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUERY TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('addtab').addEventListener('click', ()=>{
  const id = ++tabN;
  const el = document.createElement('div');
  el.className='qtab'; el.dataset.tab=id;
  el.innerHTML=`<span>Query ${id}</span><span class="qx">√ó</span>`;
  document.getElementById('addtab').before(el);
  const tmp = document.createElement('div');
  tmp.style.height='100%';
  editors[id] = mkEditor(tmp);
  switchTab(id);
});

document.getElementById('qtabs').addEventListener('click', e=>{
  const tab = e.target.closest('.qtab');
  if (!tab) return;
  if (e.target.classList.contains('qx')){ closeTab(+tab.dataset.tab); return; }
  switchTab(+tab.dataset.tab);
});

function switchTab(id){
  document.querySelectorAll('.qtab').forEach(t=>t.classList.toggle('on',+t.dataset.tab===id));
  const box=document.getElementById('edbox');
  box.innerHTML='';
  if (editors[id]){ box.appendChild(editors[id].getWrapperElement()); setTimeout(()=>editors[id].refresh(),30); }
  actTab=id;
}
function closeTab(id){
  if (Object.keys(editors).length<=1) return;
  document.querySelector(`.qtab[data-tab="${id}"]`)?.remove();
  delete editors[id];
  if (actTab===id){ const ids=Object.keys(editors); switchTab(+ids[ids.length-1]); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RUN QUERY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('runbtn').addEventListener('click', runQ);
document.getElementById('fmtbtn').addEventListener('click', ()=>{ const e=ed(); e.setValue(fmtSQL(e.getValue())); });
document.getElementById('clrbtn').addEventListener('click', ()=> ed().setValue(''));

function runQ() {
  if (!DB) return;
  const e   = ed();
  const sql = e.getSelection() || e.getValue();
  if (!sql.trim()) return;

  const limit = document.getElementById('lsel').value;
  const stmts = splitSQL(sql);

  showLoad(true);
  setStatus('busy','Running‚Ä¶');
  clearRes();

  const t0=Date.now();
  let lastRes=null, errMsg=null;

  try {
    for (let i=0;i<stmts.length;i++) {
      let s=stmts[i].trim();
      if (!s) continue;
      if (i===stmts.length-1 && limit && /^SELECT\b/i.test(s) && !/\bLIMIT\b/i.test(s))
        s+=` LIMIT ${limit}`;
      const r=DB.exec(s);
      if (r.length) lastRes=r[0];
    }
    const ms=Date.now()-t0;
    if (lastRes) {
      const {columns,values}=lastRes;
      const rows=values.map(r=>{ const o={}; columns.forEach((c,i)=>o[c]=r[i]); return o; });
      res={cols:columns, rows, filtered:rows};
      pg=0; sCol=-1;
      renderTbl(res.filtered, columns);
      setMeta(`<span class="ok">‚úì</span> ${rows.length.toLocaleString()} row${rows.length!==1?'s':''} ¬∑ ${ms}ms`);
      addHist(sql,rows.length,ms,'ok');
    } else {
      const ms2=Date.now()-t0;
      setMeta(`<span class="ok">‚úì</span> Query OK ¬∑ ${ms2}ms`);
      addHist(sql,0,ms2,'ok');
      showLoad(false);
      const ph=document.getElementById('ph');
      ph.style.display='flex';
      ph.innerHTML='<div class="phico">‚úÖ</div><div style="font-size:13px">Executed successfully</div>';
      refreshSidebar();
    }
    setStatus('ready','Done');
  } catch(e) {
    showLoad(false);
    const ms2=Date.now()-t0;
    setMeta(`<span class="er">‚úó</span> ${esc(e.message.slice(0,120))}`);
    addHist(sql,0,ms2,'err');
    setStatus('ready','Error');
    toast(e.message.slice(0,100),'er');
  }
}

function splitSQL(sql) {
  // Split on semicolons not inside strings/comments
  const out=[]; let cur='', inStr=false, strCh='';
  for (let i=0;i<sql.length;i++){
    const c=sql[i];
    if (inStr){ cur+=c; if(c===strCh && sql[i-1]!=='\\') inStr=false; }
    else if (c==="'" || c==='"'){ inStr=true; strCh=c; cur+=c; }
    else if (c===';'){ const t=cur.trim(); if(t) out.push(t); cur=''; }
    else cur+=c;
  }
  const t=cur.trim(); if(t) out.push(t);
  return out.length?out:[sql];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTbl(rows, cols, p=0) {
  showLoad(false);
  document.getElementById('ph').style.display='none';

  const totalPgs = Math.ceil(rows.length/PAGE);
  const pageRows = rows.slice(p*PAGE,(p+1)*PAGE);

  // Determine display type for each column from first 50 rows
  const dispTypes = cols.map(c=>{
    const samp=rows.slice(0,50).map(r=>r[c]).filter(v=>v!==null&&v!==undefined);
    if (!samp.length) return 'NULL';
    if (samp.every(v=>typeof v==='number'||typeof v==='bigint')){
      return samp.every(v=>Number.isInteger(Number(v)))?'INTEGER':'REAL';
    }
    if (samp.every(v=>/^\d{4}-\d{2}-\d{2}/.test(String(v)))) return 'DATE';
    return 'TEXT';
  });

  let html='<table class="rt"><thead><tr><th>#</th>';
  cols.forEach((c,i)=>{
    const cls=sCol===i?(sDir===1?'sasc':'sdsc'):'';
    html+=`<th class="${cls}" data-ci="${i}" data-cn="${esc(c)}">${esc(c)}<span class="ctype">${dispTypes[i]}</span><span class="sarr">‚Üë</span></th>`;
  });
  html+='</tr></thead><tbody>';

  pageRows.forEach((row,ri)=>{
    html+=`<tr><td>${p*PAGE+ri+1}</td>`;
    cols.forEach((c,i)=>{
      const v=row[c];
      if (v===null||v===undefined) html+=`<td class="vnull">NULL</td>`;
      else if (typeof v==='number'||typeof v==='bigint') html+=`<td class="vnum">${esc(String(v))}</td>`;
      else html+=`<td>${esc(String(v))}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';

  const dt=document.getElementById('dtable');
  dt.innerHTML=html; dt.className='on';

  dt.querySelectorAll('th[data-ci]').forEach(th=>{
    th.addEventListener('click',()=>{
      const ci=+th.dataset.ci, cn=th.dataset.cn;
      if (sCol===ci) sDir*=-1; else { sCol=ci; sDir=1; }
      const sorted=[...res.filtered].sort((a,b)=>{
        const av=a[cn],bv=b[cn];
        if (av===null) return 1; if (bv===null) return -1;
        return (av<bv?-1:av>bv?1:0)*sDir;
      });
      res.filtered=sorted; pg=0; renderTbl(sorted,cols,0);
    });
  });

  // Pager
  const pager=document.getElementById('pager');
  if (totalPgs>1){
    pager.style.display='flex';
    document.getElementById('pinfo').textContent=`Page ${p+1} / ${totalPgs}`;
    document.getElementById('pcount').textContent=`${rows.length.toLocaleString()} rows`;
    const pp=document.getElementById('pprev'), pn=document.getElementById('pnext');
    pp.disabled=p===0; pn.disabled=p>=totalPgs-1;
    pp.onclick=()=>{ pg--; renderTbl(res.filtered,cols,pg); };
    pn.onclick=()=>{ pg++; renderTbl(res.filtered,cols,pg); };
  } else { pager.style.display='none'; }

  document.getElementById('vtog').style.display='flex';
  document.getElementById('csvbtn').style.display='';
  document.getElementById('cpybtn').style.display='';
  document.getElementById('rfilter').style.display='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROW FILTER  ‚Äî supports text search AND numeric operators
//   Examples: "MCX"  ">=100"  ">0"  "<=50"  "=NRML"  "!=0"
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('rfilter').addEventListener('input', e=>{
  if (!res) return;
  const q = e.target.value.trim();
  if (!q) {
    res.filtered = res.rows;
  } else {
    const op = q.match(/^(>=|<=|!=|>|<|=)(.+)$/);
    if (op) {
      const operator = op[1];
      const raw = op[2].trim();
      const num = parseFloat(raw.replace(/,/g,''));
      if (!isNaN(num)) {
        // Numeric operator filter ‚Äî checks ALL columns
        res.filtered = res.rows.filter(row =>
          Object.values(row).some(v => {
            if (v===null) return false;
            const n = typeof v==='number' ? v : parseFloat(String(v).replace(/,/g,''));
            if (isNaN(n)) return false;
            if (operator==='>=') return n>=num;
            if (operator==='<=') return n<=num;
            if (operator==='>')  return n>num;
            if (operator==='<')  return n<num;
            if (operator==='=')  return n===num;
            if (operator==='!=') return n!==num;
          })
        );
      } else {
        // String equality / inequality
        const sv = raw.toLowerCase();
        res.filtered = res.rows.filter(row =>
          Object.values(row).some(v => {
            if (v===null) return false;
            const s = String(v).toLowerCase();
            if (operator==='=')  return s===sv;
            if (operator==='!=') return s!==sv;
            return s.includes(sv);
          })
        );
      }
    } else {
      // Substring search
      const ql = q.toLowerCase();
      res.filtered = res.rows.filter(row =>
        Object.values(row).some(v => v!==null && String(v).toLowerCase().includes(ql))
      );
    }
  }
  pg=0; sCol=-1;
  renderTbl(res.filtered, res.cols, 0);
  // Update meta to show filtered count
  const total=res.rows.length, shown=res.filtered.length;
  if (shown!==total)
    setMeta(`<span class="ok">‚úì</span> ${shown.toLocaleString()} / ${total.toLocaleString()} rows (filtered)`);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('vtog').addEventListener('click', e=>{
  const btn=e.target.closest('.vbtn');
  if (!btn||!res) return;
  document.querySelectorAll('.vbtn').forEach(b=>b.classList.toggle('on',b===btn));
  if (btn.dataset.v==='json'){
    document.getElementById('dtable').className='';
    document.getElementById('jview').className='on';
    document.getElementById('jpre').textContent=JSON.stringify(res.filtered.slice(0,500),null,2);
  } else {
    document.getElementById('jview').className='';
    renderTbl(res.filtered,res.cols,pg);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('csvbtn').addEventListener('click',()=>{
  if (!res) return;
  const {cols,filtered}=res;
  const hdr=cols.map(c=>JSON.stringify(c)).join(',');
  const body=filtered.map(row=>cols.map(c=>{
    const v=row[c]; if (v===null) return '';
    const s=String(v);
    return (s.includes(',')||s.includes('"')||s.includes('\n'))?JSON.stringify(s):s;
  }).join(',')).join('\n');
  dlFile(hdr+'\n'+body,'results.csv','text/csv');
});

document.getElementById('cpybtn').addEventListener('click',()=>{
  if (!res) return;
  const {cols,filtered}=res;
  const tsv=[cols.join('\t'),...filtered.map(r=>cols.map(c=>r[c]??'').join('\t'))].join('\n');
  navigator.clipboard.writeText(tsv).then(()=>toast('Copied as TSV ‚úì','ok'));
});

function dlFile(content,name,type){
  const a=Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(new Blob([content],{type})),download:name
  });
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addHist(sql,rows,ms,status){
  hist.unshift({sql,rows,ms,status,t:new Date()});
  if (hist.length>100) hist.pop();
  renderHist();
}
function renderHist(){
  const list=document.getElementById('hlist');
  if (!hist.length) return;
  list.innerHTML='';
  hist.slice(0,50).forEach(h=>{
    const el=document.createElement('div');
    el.className='hi';
    el.innerHTML=`<div class="hsql">${esc(h.sql.replace(/\s+/g,' ').trim())}</div>
      <div class="hmeta">
        <span class="${h.status==='ok'?'ok':'er'}">${h.status==='ok'?'‚úì':'‚úó'} ${Number(h.rows).toLocaleString()} rows</span>
        <span>${h.ms}ms</span><span>${h.t.toLocaleTimeString()}</span>
      </div>`;
    el.addEventListener('click',()=>{ ed().setValue(h.sql); switchPanel('tp'); });
    list.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR PANEL SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.stab').forEach(t=>t.addEventListener('click',()=>switchPanel(t.dataset.p)));
function switchPanel(id){
  document.querySelectorAll('.stab').forEach(t=>t.classList.toggle('on',t.dataset.p===id));
  document.querySelectorAll('.spanel').forEach(p=>p.classList.toggle('on',p.id===id));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SNIPPETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.snip').forEach(el=>{
  el.addEventListener('click',()=>{ ed().setValue(el.dataset.sql.replace(/\\n/g,'\n')); switchPanel('tp'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESIZE HANDLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sr=false;
document.getElementById('sresz').addEventListener('mousedown',e=>{sr=true;e.preventDefault();});
document.addEventListener('mousemove',e=>{
  if(!sr)return;
  document.getElementById('sidebar').style.width=Math.max(180,Math.min(480,e.clientX))+'px';
});
document.addEventListener('mouseup',()=>sr=false);

let er=false,ey=0,eh=0;
document.getElementById('rhandle').addEventListener('mousedown',e=>{er=true;ey=e.clientY;eh=document.getElementById('edbox').offsetHeight;e.preventDefault();});
document.addEventListener('mousemove',e=>{
  if(!er)return;
  const h=Math.max(60,Math.min(600,eh+e.clientY-ey));
  document.getElementById('edbox').style.height=h+'px';
  ed().refresh();
});
document.addEventListener('mouseup',()=>er=false);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clearRes(){
  res=null;
  document.getElementById('dtable').className='';
  document.getElementById('dtable').innerHTML='';
  document.getElementById('jview').className='';
  document.getElementById('ph').style.display='none';
  document.getElementById('pager').style.display='none';
  document.getElementById('vtog').style.display='none';
  document.getElementById('csvbtn').style.display='none';
  document.getElementById('cpybtn').style.display='none';
  document.getElementById('rfilter').style.display='none';
  document.getElementById('rfilter').value='';
  document.querySelectorAll('.vbtn').forEach((b,i)=>b.classList.toggle('on',i===0));
}
function showLoad(v){ document.getElementById('loading').className=v?'on':''; }
function setMeta(h){ document.getElementById('rmeta').innerHTML=h; }

function fmtSQL(sql){
  ['SELECT','FROM','WHERE','GROUP BY','ORDER BY','HAVING','LIMIT','OFFSET',
   'JOIN','LEFT JOIN','RIGHT JOIN','INNER JOIN','CROSS JOIN','ON','AND','OR','NOT',
   'AS','WITH','UNION','INSERT INTO','VALUES','UPDATE','SET','DELETE FROM',
   'CREATE TABLE','DROP TABLE','ALTER TABLE','PRAGMA'].forEach(k=>{
    sql=sql.replace(new RegExp(`\\b${k}\\b`,'gi'),k);
  });
  return sql;
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let tTmr;
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`on ${type}`;
  clearTimeout(tTmr); tTmr=setTimeout(()=>el.className='',3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
init();
</script>
</body>
</html>
